```cypher
match (v:V_FnCallLog {direct:1})
where v.deepth is not null and v.width is not null
and not (v.fnSym_fileName   starts with "/usr/include/c++")
and v.fnSym_fileName <> ""
// and v.fnSym_fileName STARTS WITH "/home/z/torch-repo/pytorch"
// and v.fnSym_name  <>"THFloatTensor_uniform"
// and v.fnSym_name <> "__destroy<std::shared_ptr<torch::jit::Operator>*>"
// and v.fnSym_name <> "_M_deallocate_nodes"
// and v.fnSym_name <> "__destroy<c10::InternedStrings::SymbolInfo*>"
// and v.fnSym_name <> "__do_global_dtors_aux"
// and v.fnSym_name <> "__destroy<std::unique_ptr<torch::jit::script::TokenTrie>*>"
return v.fnCallId,v.fnSym_name,v.deepth,v.width,v.fnSym_moduleName, replace( v.fnSym_fileName,"/home/z/torch-repo/pytorch",".") as fnSym_fileName , v.fnSym_lineNumber, v.fnSym_column,v.fnAdr
order by v.deepth * (v.width-1) desc
limit 20


```

```txt
╒══════════╤════════════════════════════════════════════════════════════════════╤══════╤═════╤═══════════════╤════════════════════════════════════════════════════╤═════╤═══╤════════════════╕
│v.fnCallId│fnm                                                                 │deepth│width│mn             │srcf                                                │ln   │col│fnAdr           │
╞══════════╪════════════════════════════════════════════════════════════════════╪══════╪═════╪═══════════════╪════════════════════════════════════════════════════╪═════╪═══╪════════════════╡
│3093      │"THFloatTensor_uniform"                                             │5     │50211│"libcaffe2.so" │"./aten/src/TH/generic/THTensorRandom.cpp"          │71   │1  │"0x7ffff3750ab0"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│162866    │"THFloatVector_normal_fill_AVX2"                                    │4     │4165 │"libcaffe2.so" │"./aten/src/ATen/native/cpu/avx_mathfun.h"          │159  │31 │"0x7ffff3c3e879"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│158301    │"THFloatTensor_uniform"                                             │5     │675  │"libcaffe2.so" │"./aten/src/TH/generic/THTensorRandom.cpp"          │71   │1  │"0x7ffff3750ab0"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│185504    │"apply_op<at::native::_copy_same_type__cpu(at::Tensor&, const at::Te│3     │970  │"libcaffe2.so" │"./aten/src/ATen/CPUApplyUtils.h"                   │314  │1  │"0x7ffff33813b2"│
│          │nsor&)::<lambda()>::<lambda()>::<lambda(scalar_t&, const scalar_t&)>│      │     │               │                                                    │     │   │                │
│          │, at::strided_tensor_iter_fixed<float, 8>, at::strided_tensor_iter_f│      │     │               │                                                    │     │   │                │
│          │ixed<float, 8> >"                                                   │      │     │               │                                                    │     │   │                │
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│198845    │"addmm"                                                             │29    │46   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│6121 │124│"0x7ffff6e02d64"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│180039    │"addmm"                                                             │29    │46   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│6121 │124│"0x7ffff6e02d64"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│186       │"reset"                                                             │36    │31   │"libtorch.so.1"│"./torch/csrc/api/src/nn/modules/linear.cpp"        │17   │26 │"0x7ffff77314f4"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│188895    │"relu"                                                              │32    │31   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│9727 │54 │"0x7ffff6e26aa4"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│193239    │"cpuinfo_linux_parse_multiline_file"                                │2     │449  │"libcaffe2.so" │"./third_party/cpuinfo/src/linux/multiline.c"       │21   │1  │"0x7ffff4da9adb"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│177641    │"t"                                                                 │33    │25   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_1.cpp"│11854│51 │"0x7ffff6ee8ee6"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│196702    │"t"                                                                 │29    │25   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_1.cpp"│11854│51 │"0x7ffff6ee8ee6"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│183618    │"THFloatTensor_addmm"                                               │19    │36   │"libcaffe2.so" │"./aten/src/TH/generic/THTensorMath.cpp"            │928  │1  │"0x7ffff37822ee"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│202397    │"THFloatTensor_addmm"                                               │19    │36   │"libcaffe2.so" │"./aten/src/TH/generic/THTensorMath.cpp"            │928  │1  │"0x7ffff37822ee"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│193190    │"cpuinfo_x86_linux_init"                                            │4     │153  │"libcaffe2.so" │"./third_party/cpuinfo/src/x86/linux/init.c"        │144  │35 │"0x7ffff4da77ad"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│190134    │"build"                                                             │24    │25   │"libcaffe2.so" │"./aten/src/ATen/native/TensorIterator.cpp"         │616  │66 │"0x7ffff34c04e6"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│155727    │"reset"                                                             │19    │31   │"libtorch.so.1"│"./torch/csrc/api/src/nn/modules/linear.cpp"        │17   │26 │"0x7ffff77314f4"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│219228    │"select"                                                            │17    │32   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│10096│84 │"0x7ffff6e2a548"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│216585    │"select"                                                            │17    │32   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│10096│84 │"0x7ffff6e2a548"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│221871    │"select"                                                            │17    │32   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│10096│84 │"0x7ffff6e2a548"│
├──────────┼────────────────────────────────────────────────────────────────────┼──────┼─────┼───────────────┼────────────────────────────────────────────────────┼─────┼───┼────────────────┤
│213942    │"select"                                                            │17    │32   │"libtorch.so.1"│"./torch/csrc/autograd/generated/VariableType_0.cpp"│10096│84 │"0x7ffff6e2a548"│
└──────────┴────────────────────────────────────────────────────────────────────┴──────┴─────┴───────────────┴────────────────────────────────────────────────────┴─────┴───┴────────────────┘

```

###  TH_TENSOR_APPLY是一个内部带有循环语句的宏

[aten/src/TH/generic/THTensorRandom.cpp](https://gitee.com/mirrr/pytorch/blob/v1.3.1/aten/src/TH/generic/THTensorRandom.cpp) 中的函数```THTensor_(uniform)```  fnCallId==3093 宽度width==50211 , 但是该函数源代码行数只有8行，原因直接解释为 TH_TENSOR_APPLY是一个内部带有循环语句的宏

```cpp
void THTensor_(uniform)(THTensor *self, THGenerator *_generator, double a, double b)
{
//...
  #if ...
  TH_TENSOR_APPLY(...); 
  #else
  TH_TENSOR_APPLY(...);
  #endif
}
```

#### TH_TENSOR_APPLY内部干了啥？

```cypher
with 3093 as parentFnCallId
MATCH (v:V_FnCallLog {direct: 1})
match (parent:V_FnCallLog {direct:1, fnCallId:parentFnCallId})
with v,parent
WHERE v.fnCallId IN apoc.convert.fromJsonList(parent.sonFnCallIdLs)
RETURN DISTINCT v.fnSym_name, v.fnSym_fileName, v.fnSym_lineNumber, v.fnSym_column
```

结果如下， 可见下面这些函数们 就是 宏 TH_TENSOR_APPLY 内部做的事情
```
╒════════════════════════════════════╤════════════════════════════════════════════════════════════╤══════════════════╤══════════════╕
│v.fnSym_name                        │v.fnSym_fileName                                            │v.fnSym_lineNumber│v.fnSym_column│
╞════════════════════════════════════╪════════════════════════════════════════════════════════════╪══════════════════╪══════════════╡
│"THRandom_uniformFloat"             │"/home/z/torch-repo/pytorch/aten/src/TH/THRandom.cpp"       │263               │1             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"stride"                            │"/home/z/torch-repo/pytorch/c10/core/Backend.h"             │197               │47            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"THTensor_sizeLegacyNoScalars"      │"/home/z/torch-repo/pytorch/aten/src/TH/THTensor.hpp"       │86                │1             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"dim"                               │"/home/z/torch-repo/pytorch/c10/core/Backend.h"             │75                │21            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"THTensor_strideLegacyNoScalars"    │"/home/z/torch-repo/pytorch/aten/src/TH/THTensor.hpp"       │79                │78            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"size"                              │"/home/z/torch-repo/pytorch/c10/core/Backend.h"             │79                │5             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"THTensor_nDimensionLegacyAll"      │"/home/z/torch-repo/pytorch/aten/src/TH/THTensor.hpp"       │69                │65            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"data<float>"                       │"/home/z/torch-repo/pytorch/c10/core/StorageImpl.h"         │69                │13            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"is_empty"                          │"/home/z/torch-repo/pytorch/aten/src/ATen/core/TensorImpl.h"│716               │15            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"THFree"                            │"/home/z/torch-repo/pytorch/aten/src/TH/THGeneral.cpp"      │234               │1             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"storage_offset"                    │"/home/z/torch-repo/pytorch/aten/src/ATen/core/TensorImpl.h"│709               │19            │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"_ZNSt10lock_guardISt5mutexEC1ERS0_"│""                                                          │0                 │0             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"_ZNSt10lock_guardISt5mutexED1Ev"   │""                                                          │0                 │0             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"THAlloc"                           │"/home/z/torch-repo/pytorch/aten/src/TH/THGeneral.cpp"      │184               │1             │
├────────────────────────────────────┼────────────────────────────────────────────────────────────┼──────────────────┼──────────────┤
│"THTensor_getStoragePtr"            │"/home/z/torch-repo/pytorch/aten/src/ATen/core/TensorImpl.h"│1389              │3             │
└────────────────────────────────────┴────────────────────────────────────────────────────────────┴──────────────────┴──────────────┘
```